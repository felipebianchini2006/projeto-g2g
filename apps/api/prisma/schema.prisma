generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  SELLER
  ADMIN
}

enum OAuthProvider {
  DISCORD
  GOOGLE
}

enum SupportChatStatus {
  OPEN
  CLOSED
}

enum SupportChatRole {
  USER
  AI
  SYSTEM
}

enum OrderAttributionSource {
  LINK
  COUPON
  NONE
}

enum PartnerCommissionEventType {
  EARNED
  REVERSED
}

enum ListingStatus {
  DRAFT
  PENDING
  PUBLISHED
  SUSPENDED
}

enum DeliveryType {
  AUTO
  MANUAL
}

enum ListingMediaType {
  IMAGE
  VIDEO
}

enum InventoryStatus {
  AVAILABLE
  RESERVED
  DELIVERED
  DISABLED
}

enum OrderStatus {
  CREATED
  AWAITING_PAYMENT
  PAID
  IN_DELIVERY
  DELIVERED
  COMPLETED
  CANCELLED
  DISPUTED
  REFUNDED
}

enum OrderEventType {
  CREATED
  AWAITING_PAYMENT
  PAID
  IN_DELIVERY
  DELIVERED
  COMPLETED
  CANCELLED
  REFUNDED
  DISPUTED
  NOTE
}

enum DeliveryEvidenceType {
  TEXT
  FILE
  LINK
}

enum PaymentProvider {
  EFI
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  EXPIRED
  REFUNDED
  FAILED
}

enum WebhookProvider {
  EFI
}

enum LedgerEntryType {
  CREDIT
  DEBIT
}


enum LedgerEntryState {
  HELD
  AVAILABLE
  REVERSED
}

enum LedgerEntrySource {
  ORDER_PAYMENT
  REFUND
  FEE
  PAYOUT
  WALLET_TOPUP
}

enum PayoutScope {
  USER
  PLATFORM
}

enum PayoutStatus {
  SENT
  FAILED
}

enum PixKeyType {
  CPF
  CNPJ
  EMAIL
  PHONE
  EVP
}

enum BeneficiaryType {
  PF
  PJ
}

enum PayoutSpeed {
  NORMAL
  INSTANT
}

enum ChatMessageType {
  TEXT
  SYSTEM
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum DisputeStatus {
  OPEN
  REVIEW
  RESOLVED
  REJECTED
}

enum NotificationType {
  ORDER
  PAYMENT
  CHAT
  SYSTEM
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  PERMISSION_CHANGE
  REFUND
  MANUAL_ADJUSTMENT
}

enum ReportStatus {
  OPEN
  REVIEWING
  RESOLVED
  REJECTED
}

enum ReportReason {
  SCAM
  PROHIBITED_CONTENT
  MISLEADING_DESCRIPTION
  DUPLICATE
  OTHER
}

enum RgStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  role         UserRole @default(USER)
  fullName     String?
  cpf          String?  @unique
  birthDate    String?
  addressZip   String?
  addressStreet String?
  addressNumber String?
  addressComplement String?
  addressDistrict String?
  addressCity  String?
  addressState String?
  addressCountry String?
  avatarUrl    String?
  verificationFeeOrderId String? @unique
  verificationFeePaidAt DateTime?
  payoutPixKey String?
  payoutBlockedAt DateTime?
  payoutBlockedReason String?
  blockedAt    DateTime?
  blockedReason String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  sessions            Session[]
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  listings            Listing[]
  ordersAsBuyer        Order[]        @relation("OrderBuyer")
  ordersAsSeller       Order[]        @relation("OrderSeller")
  orderItemSnapshotsAsSeller OrderItemSnapshot[] @relation("OrderItemSeller")
  payments            Payment[]
  ledgerEntries       LedgerEntry[]
  chatMessages        ChatMessage[]
  chatRoomReads       ChatRoomRead[]
  tickets             Ticket[]
  ticketMessages      TicketMessage[]
  notifications       Notification[]
  auditLogs           AuditLog[]      @relation("AuditAdmin")
  orderEvents         OrderEvent[]    @relation("OrderEventUser")
  deliveryEvidenceCreated DeliveryEvidence[] @relation("DeliveryEvidenceCreator")
  oauthAccounts       OAuthAccount[]
  supportChatSessions SupportChatSession[]
  sellerReviewsReceived SellerReview[] @relation("SellerReviewSeller")
  sellerReviewsGiven    SellerReview[] @relation("SellerReviewBuyer")
  communityPosts        CommunityPost[] @relation("CommunityPostAuthor")
  communityPostLikes    CommunityPostLike[] @relation("CommunityPostLikeUser")
  communityPostComments CommunityPostComment[] @relation("CommunityPostCommentUser")
  followers            UserFollow[] @relation("UserFollowers")
  following            UserFollow[] @relation("UserFollowing")
  directChatThreadsAsUserA DirectChatThread[] @relation("DirectChatUserA")
  directChatThreadsAsUserB DirectChatThread[] @relation("DirectChatUserB")
  directChatMessages       DirectChatMessage[] @relation("DirectChatSender")
  listingQuestionsAsked    ListingQuestion[] @relation("ListingQuestionAskedBy")
  listingQuestionsAnswered ListingQuestion[] @relation("ListingQuestionAnsweredBy")
  listingReportsSubmitted  ListingReport[]   @relation("ListingReportReporter")
  listingReportsReviewed   ListingReport[]   @relation("ListingReportAdmin")
  rgVerifications          RgVerification[]  @relation("RgVerificationUser")
  rgReviewsAsAdmin         RgVerification[]  @relation("RgVerificationAdmin")
  payoutsReceived          Payout[]          @relation("PayoutUser")
  payoutsRequested         Payout[]          @relation("PayoutRequestedBy")

  @@map("users")
}

model RgVerification {
  id                String    @id @default(cuid())
  userId            String
  rgNumber          String
  rgPhotoUrl        String
  status            RgStatus  @default(PENDING)
  submittedAt       DateTime  @default(now())
  reviewedAt        DateTime?
  reviewedByAdminId String?
  adminReason       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user            User  @relation("RgVerificationUser", fields: [userId], references: [id], onDelete: Cascade)
  reviewedByAdmin User? @relation("RgVerificationAdmin", fields: [reviewedByAdminId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([submittedAt])
  @@map("rg_verifications")
}

model Partner {
  id             String   @id @default(uuid())
  name           String
  slug           String   @unique
  commissionBps  Int      @default(6500)
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  coupons             Coupon[]
  attributions        OrderAttribution[]
  clicks              PartnerClick[]
  commissionEvents    PartnerCommissionEvent[]

  @@index([active])
  @@map("partners")
}

model Coupon {
  id            String   @id @default(uuid())
  code          String   @unique
  partnerId     String?
  active        Boolean  @default(true)
  discountBps   Int?
  discountCents Int?
  startsAt      DateTime?
  endsAt        DateTime?
  maxUses       Int?
  usesCount     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  partner      Partner?           @relation(fields: [partnerId], references: [id])
  attributions OrderAttribution[]

  @@index([partnerId])
  @@index([active])
  @@map("coupons")
}

model OrderAttribution {
  id                    String                 @id @default(uuid())
  orderId               String                 @unique
  partnerId             String?
  couponId              String?
  source                OrderAttributionSource @default(NONE)
  originalTotalCents    Int
  discountAppliedCents  Int
  platformFeeBaseCents  Int
  platformFeeFinalCents Int
  partnerCommissionCents Int
  createdAt             DateTime               @default(now())

  order    Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  partner  Partner? @relation(fields: [partnerId], references: [id])
  coupon   Coupon?  @relation(fields: [couponId], references: [id])

  @@index([partnerId])
  @@index([couponId])
  @@index([source])
  @@map("order_attributions")
}

model PartnerClick {
  id         String   @id @default(uuid())
  partnerId  String
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())

  partner Partner @relation(fields: [partnerId], references: [id])

  @@index([partnerId])
  @@index([createdAt])
  @@map("partner_clicks")
}

model PartnerCommissionEvent {
  id         String                     @id @default(uuid())
  partnerId  String
  orderId    String
  amountCents Int
  type       PartnerCommissionEventType
  createdAt  DateTime                   @default(now())

  partner Partner @relation(fields: [partnerId], references: [id])
  order   Order   @relation(fields: [orderId], references: [id])

  @@unique([partnerId, orderId, type])
  @@index([partnerId])
  @@index([orderId])
  @@map("partner_commission_events")
}

model OAuthAccount {
  id             String        @id @default(uuid())
  provider       OAuthProvider
  providerUserId String
  userId         String
  accessToken    String?
  refreshToken   String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@index([userId])
  @@map("oauth_accounts")
}

model SupportChatSession {
  id        String           @id @default(uuid())
  userId    String?
  status    SupportChatStatus @default(OPEN)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  user     User?                @relation(fields: [userId], references: [id])
  messages SupportChatMessage[]

  @@index([userId])
  @@map("support_chat_sessions")
}

model SupportChatMessage {
  id        String          @id @default(uuid())
  sessionId String
  role      SupportChatRole
  content   String
  createdAt DateTime        @default(now())

  session SupportChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("support_chat_messages")
}

model Session {
  id         String   @id @default(uuid())
  userId     String
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  expiresAt  DateTime
  revokedAt  DateTime?

  user          User           @relation(fields: [userId], references: [id])
  refreshTokens RefreshToken[]

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model RefreshToken {
  id         String   @id @default(uuid())
  userId     String
  sessionId  String?
  tokenHash  String   @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  expiresAt  DateTime
  revokedAt  DateTime?

  user    User     @relation(fields: [userId], references: [id])
  session Session? @relation(fields: [sessionId], references: [id])

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id         String   @id @default(uuid())
  userId     String
  tokenHash  String   @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  expiresAt  DateTime
  usedAt     DateTime?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model Category {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  listings Listing[]
  groups   CategoryGroup[]

  @@index([name])
  @@map("categories")
}

model CategoryGroup {
  id          String   @id @default(uuid())
  categoryId  String
  name        String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category Category @relation(fields: [categoryId], references: [id])
  sections CategorySection[]
  listings Listing[]

  @@index([categoryId])
  @@index([name])
  @@map("category_groups")
}

model CategorySection {
  id          String   @id @default(uuid())
  groupId     String
  name        String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  group    CategoryGroup @relation(fields: [groupId], references: [id])
  listings Listing[]

  @@index([groupId])
  @@index([name])
  @@map("category_sections")
}

model SalesModel {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  listings Listing[]

  @@index([name])
  @@map("sales_models")
}

model OriginOption {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  listings Listing[]

  @@index([name])
  @@map("origin_options")
}

model RecoveryOption {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  listings Listing[]

  @@index([name])
  @@map("recovery_options")
}

model Listing {
  id           String        @id @default(uuid())
  sellerId     String
  categoryId   String
  categoryGroupId String?
  categorySectionId String?
  salesModelId String?
  originId     String?
  recoveryOptionId String?
  title        String
  slug         String?       @unique
  description  String?
  priceCents   Int
  currency     String        @default("BRL")
  status       ListingStatus @default(DRAFT)
  platformFeeBps Int?
  featuredAt   DateTime?
  mustHaveAt   DateTime?
  deliveryType DeliveryType
  deliverySlaHours Int       @default(24)
  refundPolicy String        @default("Refund policy pending.")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  seller              User               @relation(fields: [sellerId], references: [id])
  category            Category           @relation(fields: [categoryId], references: [id])
  categoryGroup       CategoryGroup?     @relation(fields: [categoryGroupId], references: [id])
  categorySection     CategorySection?   @relation(fields: [categorySectionId], references: [id])
  salesModel          SalesModel?        @relation(fields: [salesModelId], references: [id])
  origin              OriginOption?      @relation(fields: [originId], references: [id])
  recoveryOption      RecoveryOption?    @relation(fields: [recoveryOptionId], references: [id])
  media               ListingMedia[]
  inventoryItems      InventoryItem[]
  orderItemSnapshots  OrderItemSnapshot[]
  questions           ListingQuestion[]
  reports             ListingReport[]

  @@index([sellerId])
  @@index([categoryId])
  @@index([categoryGroupId])
  @@index([categorySectionId])
  @@index([salesModelId])
  @@index([originId])
  @@index([recoveryOptionId])
  @@index([status])
  @@index([featuredAt])
  @@index([mustHaveAt])
  @@index([title])
  @@map("listings")
}

model ListingReport {
  id              String       @id @default(cuid())
  listingId       String
  reporterId      String
  reason          ReportReason
  message         String?
  status          ReportStatus @default(OPEN)
  reviewedByAdminId String?
  adminNote       String?
  resolvedAt      DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  listing        Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  reporter       User    @relation("ListingReportReporter", fields: [reporterId], references: [id])
  reviewedByAdmin User?  @relation("ListingReportAdmin", fields: [reviewedByAdminId], references: [id])

  @@index([listingId])
  @@index([reporterId])
  @@index([status])
  @@index([createdAt])
  @@map("listing_reports")
}

model ListingMedia {
  id        String           @id @default(uuid())
  listingId String
  url       String
  type      ListingMediaType @default(IMAGE)
  position  Int              @default(0)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@map("listing_media")
}

model InventoryItem {
  id          String          @id @default(uuid())
  listingId   String
  orderItemId String?
  code        String
  status      InventoryStatus @default(AVAILABLE)
  reservedAt  DateTime?
  deliveredAt DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  listing   Listing            @relation(fields: [listingId], references: [id], onDelete: Cascade)
  orderItem OrderItemSnapshot? @relation(fields: [orderItemId], references: [id])

  @@index([listingId])
  @@index([status])
  @@map("inventory_items")
}

model Order {
  id               String      @id @default(uuid())
  buyerId          String
  sellerId         String?
  status           OrderStatus @default(CREATED)
  totalAmountCents Int
  currency         String      @default("BRL")
  expiresAt        DateTime?
  deliveredAt      DateTime?
  completedAt      DateTime?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  buyer        User               @relation("OrderBuyer", fields: [buyerId], references: [id])
  seller       User?              @relation("OrderSeller", fields: [sellerId], references: [id])
  items        OrderItemSnapshot[]
  events       OrderEvent[]
  payments     Payment[]
  ledgerEntries LedgerEntry[]
  attribution OrderAttribution?
  partnerCommissionEvents PartnerCommissionEvent[]
  chatRoom     ChatRoom?
  ticket       Ticket?
  dispute      Dispute?
  sellerReview SellerReview? @relation("SellerReviewOrder")

  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([expiresAt])
  @@index([deliveredAt])
  @@map("orders")
}

model OrderItemSnapshot {
  id             String       @id @default(uuid())
  orderId        String
  listingId      String?
  sellerId       String?
  title          String
  unitPriceCents Int
  quantity       Int          @default(1)
  deliveryType   DeliveryType
  currency       String       @default("BRL")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  order            Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)
  listing          Listing?          @relation(fields: [listingId], references: [id])
  seller           User?             @relation("OrderItemSeller", fields: [sellerId], references: [id])
  inventoryItems   InventoryItem[]
  deliveryEvidence DeliveryEvidence[]
  sellerReview     SellerReview?     @relation("SellerReviewOrderItem")

  @@index([orderId])
  @@index([listingId])
  @@index([sellerId])
  @@map("order_item_snapshots")
}

model OrderEvent {
  id        String         @id @default(uuid())
  orderId   String
  userId    String?
  type      OrderEventType
  payload   Json?
  metadata  Json?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User?  @relation("OrderEventUser", fields: [userId], references: [id])

  @@index([orderId])
  @@index([type])
  @@index([userId])
  @@map("order_events")
}

model DeliveryEvidence {
  id          String               @id @default(uuid())
  orderItemId String
  type        DeliveryEvidenceType
  content     String
  createdByUserId String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  orderItem OrderItemSnapshot @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  createdByUser User? @relation("DeliveryEvidenceCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([orderItemId])
  @@index([createdByUserId])
  @@map("delivery_evidence")
}

model ListingQuestion {
  id           String   @id @default(cuid())
  listingId    String
  askedById    String
  question     String
  answer       String?
  answeredById String?
  answeredAt   DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  listing    Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  askedBy    User    @relation("ListingQuestionAskedBy", fields: [askedById], references: [id])
  answeredBy User?   @relation("ListingQuestionAnsweredBy", fields: [answeredById], references: [id], onDelete: SetNull)

  @@index([listingId])
  @@index([askedById])
  @@index([answeredById])
  @@map("listing_questions")
}

model SellerReview {
  id               String   @id @default(uuid())
  sellerId         String
  buyerId          String
  orderId          String?  @unique
  orderItemId      String?  @unique
  rating           Int
  comment          String
  verifiedPurchase Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  seller    User              @relation("SellerReviewSeller", fields: [sellerId], references: [id])
  buyer     User              @relation("SellerReviewBuyer", fields: [buyerId], references: [id])
  order     Order?             @relation("SellerReviewOrder", fields: [orderId], references: [id], onDelete: SetNull)
  orderItem OrderItemSnapshot? @relation("SellerReviewOrderItem", fields: [orderItemId], references: [id], onDelete: SetNull)

  @@index([sellerId])
  @@index([buyerId])
  @@index([orderId])
  @@map("seller_reviews")
}

model CommunityPost {
  id         String   @id @default(uuid())
  authorId   String
  title      String?
  content    String
  couponCode String?
  imageUrl   String?
  pinned     Boolean  @default(false)
  pinnedAt   DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  author   User                   @relation("CommunityPostAuthor", fields: [authorId], references: [id])
  likes    CommunityPostLike[]
  comments CommunityPostComment[]

  @@index([authorId])
  @@index([pinned])
  @@index([createdAt])
  @@map("community_posts")
}

model Payout {
  id              String           @id @default(uuid())
  scope           PayoutScope
  status          PayoutStatus
  userId          String?
  requestedById   String
  amountCents     Int
  currency        String           @default("BRL")
  pixKey          String
  pixKeyType      PixKeyType?
  beneficiaryName String
  beneficiaryType BeneficiaryType?
  payoutSpeed     PayoutSpeed?
  provider        String           @default("EFI")
  providerStatus  String?
  providerRef     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  user        User? @relation("PayoutUser", fields: [userId], references: [id])
  requestedBy User  @relation("PayoutRequestedBy", fields: [requestedById], references: [id])

  @@index([userId])
  @@index([requestedById])
  @@index([scope])
  @@index([status])
  @@map("payouts")
}

model CommunityPostLike {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User          @relation("CommunityPostLikeUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("community_post_likes")
}

model CommunityPostComment {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User          @relation("CommunityPostCommentUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
  @@index([createdAt])
  @@map("community_post_comments")
}

model UserFollow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  User @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("user_follows")
}

model DirectChatThread {
  id        String   @id @default(uuid())
  userAId   String
  userBId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userA    User               @relation("DirectChatUserA", fields: [userAId], references: [id], onDelete: Cascade)
  userB    User               @relation("DirectChatUserB", fields: [userBId], references: [id], onDelete: Cascade)
  messages DirectChatMessage[]

  @@unique([userAId, userBId])
  @@index([userAId])
  @@index([userBId])
  @@map("direct_chat_threads")
}

model DirectChatMessage {
  id        String   @id @default(uuid())
  threadId  String
  senderId  String
  content   String
  createdAt DateTime @default(now())

  thread DirectChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender User             @relation("DirectChatSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@index([senderId])
  @@index([createdAt])
  @@map("direct_chat_messages")
}

model Payment {
  id          String          @id @default(uuid())
  orderId     String
  payerId     String?
  provider    PaymentProvider @default(EFI)
  txid        String          @unique
  status      PaymentStatus   @default(PENDING)
  amountCents Int
  currency    String          @default("BRL")
  qrCode      String?
  copyPaste   String?
  paidAt      DateTime?
  expiresAt   DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  order         Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  payer         User?          @relation(fields: [payerId], references: [id])
  webhookEvents WebhookEvent[]
  ledgerEntries LedgerEntry[]

  @@index([orderId])
  @@index([status])
  @@index([provider])
  @@map("payments")
}

model WebhookEvent {
  id          String          @id @default(uuid())
  provider    WebhookProvider @default(EFI)
  paymentId   String?
  eventId     String          @unique
  txid        String?
  eventType   String
  payload     Json
  processedAt DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  payment Payment? @relation(fields: [paymentId], references: [id])

  @@index([txid])
  @@index([provider])
  @@map("webhook_events")
}

model LedgerEntry {
  id          String           @id @default(uuid())
  userId      String
  orderId     String?
  paymentId   String?
  type        LedgerEntryType
  state       LedgerEntryState
  source      LedgerEntrySource
  amountCents Int
  currency    String           @default("BRL")
  description String?
  availableAt DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  user    User     @relation(fields: [userId], references: [id])
  order   Order?   @relation(fields: [orderId], references: [id])
  payment Payment? @relation(fields: [paymentId], references: [id])

  @@index([userId])
  @@index([orderId])
  @@index([state])
  @@index([type])
  @@index([source])
  @@map("ledger_entries")
}

model ChatRoom {
  id        String   @id @default(uuid())
  orderId   String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order    Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  messages ChatMessage[]
  reads    ChatRoomRead[]

  @@map("chat_rooms")
}

model ChatMessage {
  id        String          @id @default(uuid())
  roomId    String
  senderId  String
  type      ChatMessageType @default(TEXT)
  content   String
  editedAt  DateTime?
  deletedAt DateTime?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  room   ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender User     @relation(fields: [senderId], references: [id])

  @@index([roomId])
  @@index([senderId])
  @@map("chat_messages")
}

model ChatRoomRead {
  id         String   @id @default(uuid())
  roomId     String
  userId     String
  lastReadAt DateTime @default(now())

  room ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id])

  @@unique([roomId, userId])
  @@index([roomId])
  @@index([userId])
  @@map("chat_room_reads")
}

model Ticket {
  id          String       @id @default(uuid())
  orderId     String?      @unique
  openedById  String
  status      TicketStatus @default(OPEN)
  subject     String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  order     Order?          @relation(fields: [orderId], references: [id])
  openedBy  User            @relation(fields: [openedById], references: [id])
  messages  TicketMessage[]
  dispute   Dispute?

  @@index([openedById])
  @@index([orderId])
  @@index([status])
  @@map("tickets")
}

model TicketMessage {
  id        String   @id @default(uuid())
  ticketId  String
  senderId  String
  message   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender User   @relation(fields: [senderId], references: [id])

  @@index([ticketId])
  @@index([senderId])
  @@map("ticket_messages")
}

model Dispute {
  id         String        @id @default(uuid())
  ticketId   String        @unique
  orderId    String        @unique
  status     DisputeStatus @default(OPEN)
  reason     String
  resolution String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  resolvedAt DateTime?

  ticket Ticket @relation(fields: [ticketId], references: [id])
  order  Order  @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([status])
  @@map("disputes")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  metadata  Json?
  readAt    DateTime?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([readAt])
  @@map("notifications")
}

model EmailOutbox {
  id           String     @id @default(uuid())
  to           String
  subject      String
  body         String
  status       EmailStatus @default(PENDING)
  errorMessage String?
  sentAt       DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([status])
  @@index([sentAt])
  @@map("email_outbox")
}

model PlatformSetting {
  id                         String   @id
  platformFeeBps             Int      @default(0)
  orderPaymentTtlSeconds     Int      @default(900)
  settlementReleaseDelayHours Int     @default(0)
  splitEnabled               Boolean  @default(false)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  @@map("platform_settings")
}

model AuditLog {
  id         String      @id @default(uuid())
  adminId    String
  action     AuditAction
  entityType String
  entityId   String?
  ip         String?
  userAgent  String?
  payload    Json?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  admin User @relation("AuditAdmin", fields: [adminId], references: [id])

  @@index([adminId])
  @@index([entityType])
  @@index([action])
  @@map("audit_logs")
}
